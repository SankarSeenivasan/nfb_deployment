name: Production Server Deployment 
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    #if: contains(github.event.head_commit.message, 'deployment')
    steps:
    - uses: actions/checkout@v2
    - name: Clone OrganGuI Repository       
      run: git clone https://SankarSeenivasan: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@github.com/SankarSeenivasan/CI-CD-Pipeline.git newely          
    - name: Install SSH Key
      uses: shimataro/ssh-key-action@v2 
      with:
          key: ${{ secrets.SSH_PRIVATE_KEY_PROD_SERVER }}
          known_hosts: unnecessary

    - name: Adding Known Hosts
      run: ssh-keyscan -p ${{ secrets.SSH_PORT_PROD_SERVER}} -H ${{ secrets.SSH_HOST_PROD_SERVER}} >> ~/.ssh/known_hosts

    - name: Sync File
      env:
          dest: "${{ secrets.SSH_USER_PROD_SERVER}}@${{ secrets.SSH_HOST_PROD_SERVER}}:/home/administration/clone_github"
      run: |
          echo "${{secrets.SSH_PRIVATE_KEY_PROD_SERVER}}" > deploy_key
          chmod 700 ./deploy_key
          sudo rsync -chav --delete \
            -e 'ssh -i ./deploy_key -o StrictHostKeyChecking=no' \
            ./newely ${{env.dest}}
    
